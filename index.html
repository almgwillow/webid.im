<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="description" content="WebID Instant Message">
	<meta name="author" content="Melvin Carvalho">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="mobile-web-app-capable" content="yes">
	<title>WebID Chat</title>

	<link rel="icon" sizes="192x192" href="images/app-icon-192.png">
	<link rel="icon" sizes="128x128" href="images/app-icon-128.png">
	<link rel="apple-touch-icon" sizes="128x128" href="images/app-icon-128.png">
	<link rel="apple-touch-icon-precomposed" sizes="128x128" href="images/app-icon-128.png">

	<!-- Polymer -->
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha256.js"></script>
	<script src="bower_components/webcomponentsjs/webcomponents.min.js"></script>
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
	<script type="text/javascript" src="https://linkeddata.github.io/tabulator/js/mashup/mashlib.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/howler/1.1.25/howler.min.js"></script>
	<script src="app/vendor/common.js"></script>


	<link rel="import" href="bower_components/core-scaffold/core-scaffold.html">
	<link rel="import" href="bower_components/core-item/core-item.html">
	<link rel="import" href="bower_components/paper-input/paper-input.html">
	<link rel="import" href="bower_components/paper-fab/paper-fab.html">
	<link rel="import" href="x-chat-list.html">
	<link rel="import" href="x-friend-list.html">
	<link rel="import" href="login.html">
	<link rel="stylesheet" href="css/style.css">
</head>

<body unresolved fullbleed class="lite">

	<div class="TabulatorOutline" id="DummyUUID">
		<table id="outline"></table>
	</div>


	<template is="auto-binding">

		<core-scaffold>
			<core-header-panel navigation flex>
				<core-toolbar id="navheader" class="tall">
					<div class="middle avatar {{color}}" style="background-image: url({{avatar}})"></div>
					<div class="bottom uuid">{{name}}</div>
				</core-toolbar>

				<section layout vertical id="onlineList">
					<div id="storage">
					</div>

				</section>

			</core-header-panel>

			<div tool layout horizontal flex>
				<span flex>{{title}}</span>
				<core-icon icon="account-circle"></core-icon><span>{{occupancy}}</span>
			</div>

			<section layout vertical fit id="chat">
				<div flex class="chat-list">
					<template repeat="{{friend in friends}}">
						<x-friend-list lastActive="{{friend.lastActive}}" uri="{{friend.uri}}" img="{{friend.img}}" color="{{friend.color}}" avatar="{{friend.avatar}}" username="{{friend.name}}" text="{{friend.text}}"  status="{{friend.status}}" timestamp="{{friend.timestamp}}"></x-friend-list>
					</template>

					<webid-login id="webid-login"></webid-login>

					<div id="profile">
					</div>

					<div id="avatars">
					</div>

					<div id="names">
					</div>

					<div id="knows">
					</div>


				</div>

			</section>
		</core-scaffold>

	</template>

	<script>
	jQuery(document).ready(function() {

		// main
		'use strict';
		var template = document.querySelector('template[is=auto-binding]');

		var ldpc = 'https://klaranet.com/d/chat/'; // hard code for now until more websockets are there
		var presenceURI = ldpc + ',presence'; // FYN to add
		var webid = getParam('webid');
		var name = getParam('name') || webid;
		var avatar = getParam('avatar');
		var title = 'WebID Chat';
		var genericphoto = '/images/generic_photo.png';
		var action = 'friends';
		var color;

		// Assign a name made of a random cat and a random color
		var randomColor = function() {
			var colors = ['navy', 'slate', 'olive', 'moss', 'chocolate', 'buttercup', 'maroon', 'cerise', 'plum', 'orchid'];
			return colors[(Math.random() * colors.length) >>> 0];
		};
		color = randomColor();

		template.init = {
			ldpc : ldpc,
			presenceURI : presenceURI,
			webid : webid,
			avatar : avatar,
			color : color,
			title : title,
			action : action
		};
		template.settings = {
			ldpc : template.init.ldpc,
			presenceURI : template.init.presenceURI,
			webid : template.init.webid,
			avatar : template.init.avatar,
			color : template.init.color,
			title : template.init.title,
			action : template.init.action
		};
		if (!template.settings.name) {
			template.settings.name = template.init.webid;
		}
		if (!template.settings.avatar) {
			template.settings.avatar = genericphoto;
		}

		template.name = template.settings.name;
		template.avatar = template.settings.avatar;
		template.color = template.settings.color;
		template.title = template.settings.title;

		template.friends = [];
		template.users = {};

		function updatePresence(webid) {
			var g = $rdf.graph();
			var f = $rdf.fetcher(g);
			// add CORS proxy
			var PROXY = "https://data.fm/proxy?uri={uri}";
			//var AUTH_PROXY = "https://rww.io/auth-proxy?uri=";
			$rdf.Fetcher.crossSiteProxyTemplate=PROXY;

			var kb = tabulator.kb;
			var fetcher = tabulator.sf;


			f.nowOrWhenFetched( presenceURI , undefined, function(ok, body) {
				var USER = $rdf.Namespace("https://schema.rww.io/user#");

				var turtle = 'DELETE DATA { ';

				$.each(g.statementsMatching(undefined, USER('lastActive'), undefined), function(index, value) {
					console.log('logins : ' + value.object);
					if (webid === value.subject.value) {
  					turtle += '<'+webid+'> <https://schema.rww.io/user#lastActive> "' + value.object.value + '" . ';
					}
					setPresence(value.subject.value, value.object.value);
				});
				turtle += " } ; \n";
				console.log(turtle);

				turtle += 'INSERT DATA { <'+(webid)+'> <https://schema.rww.io/user#lastActive>  "'+ new Date().toISOString() +'" . } ';

				console.log(turtle);

				$.ajax({
					url: presenceURI,
					contentType: "application/sparql-update",
					type: 'PATCH',
					data: turtle,
					success: function(result) {
					}
				});

			});

		}


		function setPresence(webid, time) {
			var onlinetime = 86400000;
			var awaytime = 864000000;
			if (!template.users) {
				template.users = {};
			}
			var status = 'online';
			if (template.users[webid] && template.users[webid].lastActive) {
        if ( new Date(template.users[webid].lastActive) < new Date (time) ) {
					template.users[webid] = {lastActive: time};
				}
			} else {
  		  template.users[webid] = {lastActive: time};
			}

			if ( new Date().getTime() - new Date(template.users[webid].lastActive).getTime() < onlinetime ) {
				status = 'online';
			} else if ( new Date().getTime() - new Date(template.users[webid].lastActive).getTime() < awaytime ) {
				status = 'away';
      } else {
				status = 'offline';
			}

			template.users[webid].status = status;
			for(var i=0; i<template.friends.length; i++) {
				template.friends[i].statue = status;
				template.friends[i].lastActive = time;
			}
		}

		function rendermain(webid) {

      if (!webid) return;

			$('#webid-login').hide();

			var g = $rdf.graph();
			var f = $rdf.fetcher(g);
			// add CORS proxy
			var PROXY = "https://data.fm/proxy?uri={uri}";
			//var AUTH_PROXY = "https://rww.io/auth-proxy?uri=";
			$rdf.Fetcher.crossSiteProxyTemplate=PROXY;

			var kb = tabulator.kb;
			var fetcher = tabulator.sf;

			updatePresence(webid);

			console.log('rendering webid : ' + webid);

			var profileuri = (webid.split('#'))[0];

			// populate chat
			f.nowOrWhenFetched( profileuri , undefined, function(ok, body) {
				console.log('webid fetched');

				var LDP = $rdf.Namespace("http://www.w3.org/ns/ldp#");
				var RDF = $rdf.Namespace("http://www.w3.org/1999/02/22-rdf-syntax-ns#");
				var FOAF = $rdf.Namespace("http://xmlns.com/foaf/0.1/");
				var PIM = $rdf.Namespace("http://www.w3.org/ns/pim/space#");
				var RDFS = $rdf.Namespace("http://www.w3.org/2000/01/rdf-schema#");

				var webidname;
				var webidavatar;
				var storage;
				var seeAlso;

				webidavatar = g.any(kb.sym(webid), FOAF('img'))
				              || g.any(kb.sym(webid), FOAF('depiction'));
				webidname = g.any(kb.sym(webid), FOAF('name'));
				storage = g.any(kb.sym(webid), PIM('storage'));
				seeAlso = g.any(kb.sym(webid), RDFS('seeAlso'));


				function addStorage(storage) {
					if ( ! $('#storage').find('select').length ) {
						$('#storage').append($('<div>storage</div>'));
						$('#storage').append($('<hr>'));
						$('#storage').append($('<select id="storagedropdown"></select>'));
						$('#storage').append($('<hr>'));
						$('#storage').append('<div><paper-button raised="true" type="button" id="diary" target="_blank">My Journal</paper-button></div>');
						$('#diary').on('click', function() {
							var diaryURI = 'chat.html?ldpc='+ encodeURIComponent($('#storagedropdown').val())
							+ encodeURIComponent('chat/diary/') +'&webid='+encodeURIComponent(webid) + '&name='
							+ encodeURIComponent(webidname.value);
							if (webidavatar) {
								diaryURI += '&avatar=' + encodeURIComponent(webidavatar.value) + '&title=Diary';
							}
							window.open( diaryURI );
							return false;
						});
					}
					if (! $('#storagedropdown option[value="'+storage+'"]').length) {
						$('#storagedropdown').append( new Option(storage, storage) );
					}
				}

				if (webidavatar) {
  				template.avatar = webidavatar.value;
				} else {
					template.avatar = template.settings.avatar;
				}
				if (webidname) {
  				template.name = webidname.value;
				} else {
					template.name = template.settings.name;
				}

				addStorage(storage.value);

				if (seeAlso) {
					//$('#profile').append('<div>See Also : <a target="_blank" href="'+seeAlso+'">'+seeAlso+'</a></div>')
					f.nowOrWhenFetched( seeAlso.value , undefined, function(ok, body) {
						console.log('seeAlso fetched ');
						$.each(g.statementsMatching($rdf.sym(webid), PIM('storage'), undefined), function(index, value) {
							addStorage(value.object.value);
						});
					});
				}



				function addPublicChannels() {

					var ldpc = 'https://klaranet.com/d/chat/watercooler/';
					var title = 'Water Cooler (help room)';
					var name = 'Water Cooler (help room)';
					var avatar = genericphoto;


					var fr = {
					  text : 'chat.html?actin=chat&type=single&ldpc=' +encodeURIComponent(ldpc)
						       + '/&webid='+encodeURIComponent(webid)+'&name='
						       + encodeURIComponent(webidname.value) ,
						uri : '',
						name : name,
						avatar : avatar,
						status : 'online'
					}

					if (webidavatar) {
						fr.text += '&avatar=' + encodeURIComponent(webidavatar.value);
					}

					fr.text += '&title='+encodeURIComponent(title);

          // insert in right place
					template.friends.unshift( fr );

				}



				function addFriends() {
					// friends
					$.each(g.statementsMatching($rdf.sym(webid), FOAF('knows'), undefined), function(index, value) {

						var friend = value.object.value;

						var users = [webid,friend];
						users.sort();
						users = users.join("\n");
						var hash = CryptoJS.SHA256(users);
						console.log(friend);


						var profileuri = (friend.split('#'))[0];
						f.nowOrWhenFetched( profileuri , undefined, function(ok, body) {
							var name;
							var avatar;

							$.each(g.statementsMatching($rdf.sym(friend), FOAF('name'), undefined), function(index, value) {
								name = value.object.value;
							});

							$.each(g.statementsMatching($rdf.sym(friend), FOAF('depiction'), undefined), function(index, value) {
								var depiction = value.object.value;
								avatar = depiction;
							});

							$.each(g.statementsMatching($rdf.sym(friend), FOAF('img'), undefined), function(index, value) {
								var img = value.object.value;
								avatar = img;
							});


							var fr = {
							  text : 'chat.html?ldpc=' +encodeURIComponent(ldpc)+ hash
								       + '/&webid='+encodeURIComponent(webid)+'&avatar='
								       + encodeURIComponent(webidavatar.value)+'&name='
								       + encodeURIComponent(webidname.value) ,
								uri : 'chat.html?ldpc=' +encodeURIComponent(ldpc)+ hash + '/&webid='+encodeURIComponent(friend)
							}

							// add avatar
              if (avatar) {
								fr.avatar = avatar;
								fr.uri += '&avatar='+encodeURIComponent(avatar);
   						} else {
								fr.avatar = genericphoto;
	  					}

							// add name
              if (name) {
								fr.name = name;
								fr.uri += '&name='+encodeURIComponent(name);
								fr.text += '&title='+encodeURIComponent(name);
   						} else {
								fr.name = friend;
	  					}

							// add title
              if (webidname) {
								fr.uri += '&title=' + encodeURIComponent(webidname.value);
	  					}


							if (template.users && template.users[friend] ) {
								console.log('setting presence of ' + friend )
								fr.status = template.users[friend].status;
								fr.lastActive = template.users[friend].lastActive;
							}

              // insert in right place
							if (fr.status) {
								template.friends.unshift( fr );
							} else if (avatar){
								var count = 0;
						    for (var i=0; i<template.friends.length; i++) {
									if (template.friends[i].status) count++;
								}
								template.friends.splice(count, 0, fr);
							} else {
								template.friends.push( fr );
							}

						});


					});

				}

				setTimeout(addFriends, 1500);
				setTimeout(addPublicChannels, 4000);

			});

		}


		// Listen to WebIDAuth events
		window.addEventListener('WebIDAuth',function(e) {
			console.log(e.detail);
			if (e.detail.success === true) {
				console.log("Auth successful! WebID: "+e.detail.user);
				rendermain(e.detail.user);
			} else {
				console.log("Auth failed!");
				console.log(e.detail);
			}
		},false);



	});
	</script>
</body>
</html>
